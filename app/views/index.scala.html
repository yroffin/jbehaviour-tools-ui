@(message: String, params: models.params.GlobalParams)

@main("Default") {

	<div id="edit-dialog" title="Story editor">
		<textarea id="edit-dialog-story" cols="80" rows="20">
		</textarea>
	</div>

	<div id="report-dialog" title="Report">
		<textarea id="report-dialog-story" cols="80" rows="20">
		</textarea>
	</div>

	<script>
		/**
		 * call a remote ws
		 * #param action, remote action
		 * #param data, data to send
		 * #param func, function success to call
		 */
		function wsCall(action,data,func) {
			var l = window.location;
			var base_url = l.protocol + "//" + l.host;
			/**
			 * ajax call
			 */
			$.ajax({
		        url: base_url + action,
		        type: "POST",
		        data: JSON.stringify(data),
		        dataType: "json",
		        success: func
		    });
		}

		/**
		 * document initialization
		 */
		$(document).ready(function () {
			$('#edit-dialog').dialog({width: 900, autoOpen: false});
			$('#edit-dialog-story').markItUp('');
			$('#report-dialog').dialog({width: 900, autoOpen: false, modal: true});
			$('#report-dialog-story').markItUp('');

			/**
			 * script editor part
			 */
			$('#script-editor-container').markItUp('');
			$('#script-validator-output').markItUp('');
			$('#tabs').tabs();
			
			$( "#execute-script" ).button().click(function( event ) {executeScript();});
			$( "#execute-reload" ).button().click(function( event ) {renderReload();});
			
			/**
			 * dialog part
			 */
			$( "#dialog-scripts" ).dialog({ width: 800, height: 550 });
		});

		/**
		 * call a story, and execute it
		 * #param data, the story to execute
		 */
		function executeScript() {
			wsCall( "/rest/story/execute",
					{storyId: -1, rawScript: $('#script-editor-container').val()},
					function(node){
			        	$('#script-validator-output').html(node.renderedStdout);
			        }
			);
		}

		/**
		 * call a story, and execute it
		 * #param data, the story to execute
		 */
		function renderReload() {
			wsCall( "/rest/reload",
					{},
					function(node){
			        	$('#script-validator-output').html("Database reloaded ...");
			        }
			);
		}

		/**
		 * call a story, and execute it
		 * #param data, the story to execute
		 */
		function executeScenario(data) {
			/**
			 * ajax call to execute this scenario
			 */
			$.ajax({
		        type: 'GET',
		        url: $(location).attr('href') + 'rest/story/' + data.record.Id + '/execute',
		        dataType: "json",
		        success: function(data){
		        	$('#report-dialog').dialog('open');
		        	$('#report-dialog-story').html(data.Result);
		        }
		    });
		}

		/**
		 * print a story, and edit it
		 * #param data, the story to read
		 */
		function editScenario(data) {
			/**
			 * ajax call to read and print this story
			 */
			$.ajax({
		        type: 'GET',
		        url: $(location).attr('href') + 'rest/story/' + data.record.Id + '/story',
		        dataType: "json",
		        success: function(data){
		        	$('#edit-dialog').dialog('open');
		        	$('#edit-dialog-story').html(data.Story);
		        }
		    });
		}
	</script>

    <div id="dialog-scripts" title="Script editor">
    	<button id="execute-script">Execute</button>
    	<button id="execute-reload">Reload</button>
    	<div id="tabs">
    	<ul>
	        <li><a href="#tabs-1">Raw script</a></li>
	        <li><a href="#tabs-2">Output</a></li>
    	</ul>
		<div id="tabs-1">
			<textarea id="script-editor-container" cols="70" rows="8">$context.byName("Entity de test #10")</textarea>
		</div>
		<div id="tabs-2">
			<textarea id="script-validator-output" cols="70" rows="8"></textarea>
		</div>
		</div>
    </div>
}